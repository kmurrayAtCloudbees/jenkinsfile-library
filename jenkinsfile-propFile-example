// Define default values for all stage controls
def defaults = [
    'stage.build.enabled': 'true',
    'stage.unit.tests.enabled': 'true',
    'stage.integration.tests.enabled': 'true',
    'stage.security.scan.enabled': 'true',
    'stage.deploy.dev.enabled': 'true',
    'stage.deploy.preprod.enabled': 'true',
    'stage.deploy.prod.enabled': 'false'
]

def props = [:]

// Load pipeline configuration before pipeline starts
node {
    checkout scm
    props = readProperties(defaults: defaults, file: 'pipeline.properties')
    echo "Pipeline Configuration Loaded:"
    echo "  Build: ${props['stage.build.enabled']}"
    echo "  Unit Tests: ${props['stage.unit.tests.enabled']}"
    echo "  Integration Tests: ${props['stage.integration.tests.enabled']}"
    echo "  Security Scan: ${props['stage.security.scan.enabled']}"
    echo "  Deploy to Dev: ${props['stage.deploy.dev.enabled']}"
    echo "  Deploy to Preprod: ${props['stage.deploy.preprod.enabled']}"
    echo "  Deploy to Prod: ${props['stage.deploy.prod.enabled']}"
}

pipeline {
    agent any
    
    stages {
        stage('Load Pipeline Configuration') {
            steps {
                script {
                    // Define default values for all stage controls
                    def defaults = [
                        'stage.build.enabled': 'true',
                        'stage.unit.tests.enabled': 'true',
                        'stage.integration.tests.enabled': 'true',
                        'stage.security.scan.enabled': 'true',
                        'stage.deploy.dev.enabled': 'true',
                        'stage.deploy.preprod.enabled': 'true',
                        'stage.deploy.prod.enabled': 'false'
                    ]
                    
                    // Read properties file with defaults
                    def props = readProperties(defaults: defaults, file: 'pipeline.properties')
                    
                    // Make individual properties available as environment variables
                    env.BUILD_ENABLED = props.getProperty('stage.build.enabled')
                    env.UNIT_TESTS_ENABLED = props.getProperty('stage.unit.tests.enabled')
                    env.INTEGRATION_TESTS_ENABLED = props.getProperty('stage.integration.tests.enabled')
                    env.SECURITY_SCAN_ENABLED = props.getProperty('stage.security.scan.enabled')
                    env.DEPLOY_DEV_ENABLED = props.getProperty('stage.deploy.dev.enabled')
                    env.DEPLOY_PREPROD_ENABLED = props.getProperty('stage.deploy.preprod.enabled')
                    env.DEPLOY_PROD_ENABLED = props.getProperty('stage.deploy.prod.enabled')
                    
                    echo "Pipeline Configuration Loaded:"
                    echo "  Build: ${env.BUILD_ENABLED}"
                    echo "  Unit Tests: ${env.UNIT_TESTS_ENABLED}"
                    echo "  Integration Tests: ${env.INTEGRATION_TESTS_ENABLED}"
                    echo "  Security Scan: ${env.SECURITY_SCAN_ENABLED}"
                    echo "  Deploy to Dev: ${env.DEPLOY_DEV_ENABLED}"
                    echo "  Deploy to Preprod: ${env.DEPLOY_PREPROD_ENABLED}"
                    echo "  Deploy to Prod: ${env.DEPLOY_PROD_ENABLED}"
                }
            }
        }
        
        stage('Build') {
            when {
                expression { props['stage.build.enabled'] == 'true' }
            }
            steps {
                echo "I built the application"
            }
        }
        
        stage('Unit Tests') {
            when {
                expression { props['stage.unit.tests.enabled'] == 'true' }
            }
            steps {
                echo "I ran unit tests"
            }
        }
        
        stage('Integration Tests') {
            when {
                expression { props['stage.integration.tests.enabled'] == 'true' }
            }
            steps {
                echo "I ran integration tests"
            }
        }
        
        stage('Security Scan') {
            when {
                expression { props['stage.security.scan.enabled'] == 'true' }
            }
            steps {
                echo "I ran security scanning"
            }
        }
        
        stage('Deploy to Dev') {
            when {
                expression { props['stage.deploy.dev.enabled'] == 'true' }
            }
            steps {
                echo "I deployed to Dev environment"
            }
        }
        
        stage('Deploy to Preprod') {
            when {
                expression { props['stage.deploy.preprod.enabled'] == 'true' }
            }
            steps {
                echo "I deployed to Preprod environment"
            }
        }
        
        stage('Deploy to Production') {
            when {
                expression { props['stage.deploy.prod.enabled'] == 'true' }
            }
            steps {
                echo "I deployed to Production environment"
            }
        }
    }
    
    post {
        always {
            echo "Pipeline execution completed"
        }
    }
}